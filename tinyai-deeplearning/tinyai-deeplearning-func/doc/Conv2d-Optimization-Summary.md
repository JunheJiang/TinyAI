# Conv2d å·ç§¯ä¼˜åŒ–é‡æ„æ€»ç»“

## ğŸ“Š é‡æ„æ¦‚è§ˆ

**é‡æ„æ—¥æœŸ**: 2025-12-11  
**ä¼˜åŒ–ç›®æ ‡**: å°†ä½æ•ˆçš„7å±‚åµŒå¥—å¾ªç¯å·ç§¯å®ç°ä¼˜åŒ–ä¸ºé«˜æ€§èƒ½çš„ Im2Col + çŸ©é˜µä¹˜æ³•æ–¹æ¡ˆ  
**æ€§èƒ½æå‡**: é¢„æœŸ **5-10å€** (ç†è®ºå€¼ï¼Œå–å†³äºè¾“å…¥è§„æ¨¡)

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

### åŸå®ç°çš„æ€§èƒ½ç“¶é¢ˆ

1. **æ·±åº¦åµŒå¥—å¾ªç¯** (7å±‚)
   ```java
   for (batch) {
     for (outChannels) {
       for (outHeight) {
         for (outWidth) {
           for (inChannels) {
             for (kernelHeight) {
               for (kernelWidth) {
                 // è®¡ç®—...
               }
             }
           }
         }
       }
     }
   }
   ```

2. **é¢‘ç¹çš„ get/set æ“ä½œ**  
   æ¯æ¬¡è¿­ä»£è°ƒç”¨ `NdArray.get()` å’Œ `set()`ï¼Œå‡½æ•°è°ƒç”¨å¼€é”€å·¨å¤§

3. **ç¼“å­˜ä¸å‹å¥½**  
   å†…å­˜è®¿é—®æ¨¡å¼ä¸è¿ç»­ï¼ŒCPU ç¼“å­˜å‘½ä¸­ç‡ä½

4. **æ— æ³•åˆ©ç”¨ BLAS åº“**  
   ç›´æ¥å…ƒç´ çº§è®¡ç®—æ— æ³•ä½¿ç”¨é«˜åº¦ä¼˜åŒ–çš„çŸ©é˜µä¹˜æ³•åº“

---

## ğŸ—ï¸ æ–°æ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„

```
func.matrix.Conv2d (åº•å±‚ Function - Im2Colå®ç°)
    â†“ ä¾èµ–
nnet.v2.Conv2d (é«˜å±‚ Module - å‚æ•°ç®¡ç†)
```

### Im2Col ç®—æ³•åŸç†

**æ ¸å¿ƒæ€æƒ³**: å°†å·ç§¯è½¬æ¢ä¸ºçŸ©é˜µä¹˜æ³•

```
æ­¥éª¤1: Im2Col è½¬æ¢
[B, C, H, W] â†’ [B*OH*OW, C*KH*KW]
å°†æ¯ä¸ªå·ç§¯çª—å£å±•å¼€ä¸ºçŸ©é˜µçš„ä¸€è¡Œ

æ­¥éª¤2: é‡å¡‘ Kernel
[OC, C, KH, KW] â†’ [OC, C*KH*KW]

æ­¥éª¤3: çŸ©é˜µä¹˜æ³•
[B*OH*OW, C*KH*KW] @ [C*KH*KW, OC] = [B*OH*OW, OC]

æ­¥éª¤4: é‡å¡‘å› 4D
[B*OH*OW, OC] â†’ [B, OC, OH, OW]
```

---

## ğŸ“ é‡æ„ç»†èŠ‚

### 1. `func.matrix.Conv2d` é‡æ„

#### æ ¸å¿ƒä¿®æ”¹

**æ–°å¢æ–¹æ³•**:
- `im2col()` - å°†è¾“å…¥å±•å¼€ä¸ºåˆ—çŸ©é˜µ
- `col2im()` - Im2Col çš„é€†æ“ä½œï¼ˆç”¨äºåå‘ä¼ æ’­ï¼‰

**åˆ é™¤æ–¹æ³•**:
- `applyPadding()` - padding é€»è¾‘æ•´åˆåˆ° im2col ä¸­
- `performConvolution()` - ç”±çŸ©é˜µä¹˜æ³•æ›¿ä»£
- `computeInputGradient()` - ç”± col2im æ›¿ä»£
- `computeKernelGradient()` - ç”±çŸ©é˜µä¹˜æ³•æ›¿ä»£

**å‰å‘ä¼ æ’­**:
```java
// æ–°å®ç°
NdArray im2colMatrix = im2col(input, ...);
NdArray kernelReshaped = kernel.reshape(...);
NdArray output = im2colMatrix.dot(kernelReshaped.transpose());
```

**åå‘ä¼ æ’­**:
```java
// è¾“å…¥æ¢¯åº¦
NdArray gradCol = yGradFlat.dot(kernelReshaped);
NdArray inputGrad = col2im(gradCol, ...);

// Kernelæ¢¯åº¦
NdArray kernelGrad = im2colMatrix.transpose().dot(yGradFlat);
```

### 2. `nnet.v2.Conv2d` ç®€åŒ–

#### æ ¸å¿ƒä¿®æ”¹

**ç®€åŒ– forward æ–¹æ³•**:
```java
// æ—§å®ç°: 130+ è¡Œä»£ç 
performIm2Col() â†’ reshapeWeight() â†’ matMul() â†’ reshape()

// æ–°å®ç°: 15 è¡Œä»£ç 
io.leavesfly.tinyai.func.matrix.Conv2d convFunc = 
    new io.leavesfly.tinyai.func.matrix.Conv2d(stride, padding);
Variable output = convFunc.call(x, weight);
```

**åˆ é™¤æ–¹æ³•**:
- `performIm2Col()` - ç§»è‡³åº•å±‚ Function
- `reshapeWeight()` - ç§»è‡³åº•å±‚ Function

**ä¿ç•™æ–¹æ³•**:
- `addBias()` - è¿™æ˜¯ Module å±‚çš„èŒè´£ï¼Œä½¿ç”¨å¹¿æ’­æœºåˆ¶æ·»åŠ åç½®

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•ç»“æœ

### æµ‹è¯•é…ç½®

```
è¾“å…¥: [8, 64, 32, 32]
å·ç§¯æ ¸: [128, 64, 3, 3]
å‚æ•°: stride=1, padding=1
```

### æµ‹è¯•ç»“æœ

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| å¹³å‡å‰å‘ä¼ æ’­è€—æ—¶ | 263 ms |
| ååé‡ | 30.4 images/sec |
| å‰å‘ä¼ æ’­è€—æ—¶ (å°è§„æ¨¡) | 0.079 ms |
| åå‘ä¼ æ’­è€—æ—¶ (å°è§„æ¨¡) | 1.067 ms |

### ä¸åŒé…ç½®æ€§èƒ½å¯¹æ¯”

| é…ç½® | è¾“å‡ºå½¢çŠ¶ | è€—æ—¶ |
|------|---------|------|
| stride=1, padding=0 | [4, 64, 26, 26] | 26.63 ms |
| stride=1, padding=1 | [4, 64, 28, 28] | 31.54 ms |
| stride=2, padding=0 | [4, 64, 13, 13] | 6.72 ms |
| stride=2, padding=1 | [4, 64, 14, 14] | 7.78 ms |

**è§‚å¯Ÿ**:
- stride=2 æ¯” stride=1 å¿«çº¦ **4å€** (è¾“å‡ºå°ºå¯¸å‡åŠ)
- padding å¢åŠ çº¦ **15-20%** çš„è®¡ç®—å¼€é”€

---

## âœ… éªŒè¯æµ‹è¯•

### åŠŸèƒ½æ­£ç¡®æ€§

âœ… **å½¢çŠ¶éªŒè¯**: è¾“å‡ºå½¢çŠ¶å®Œå…¨æ­£ç¡®  
âœ… **æ¢¯åº¦éªŒè¯**: å‰å‘/åå‘ä¼ æ’­æ¢¯åº¦å½¢çŠ¶åŒ¹é…  
âœ… **å¤šé…ç½®æµ‹è¯•**: ä¸åŒ stride/padding ç»„åˆå‡é€šè¿‡

### æµ‹è¯•ç”¨ä¾‹

1. `testConv2dPerformance` - æ€§èƒ½åŸºå‡†æµ‹è¯•
2. `testConv2dGradient` - æ¢¯åº¦è®¡ç®—æµ‹è¯•
3. `testDifferentConfigurations` - å¤šé…ç½®æµ‹è¯•

---

## ğŸ”§ ä»£ç æ”¹åŠ¨ç»Ÿè®¡

### func.matrix.Conv2d
- **æ–°å¢**: 153 è¡Œ
- **åˆ é™¤**: 160 è¡Œ
- **å‡€å˜åŒ–**: -7 è¡Œ (ä»£ç æ›´ç®€æ´)

### nnet.v2.Conv2d
- **æ–°å¢**: 25 è¡Œ
- **åˆ é™¤**: 87 è¡Œ
- **å‡€å˜åŒ–**: -62 è¡Œ (å¤§å¹…ç®€åŒ–)

### æ€»ä½“
- **æ€»åˆ é™¤**: 247 è¡Œ
- **æ€»æ–°å¢**: 178 è¡Œ
- **ä»£ç å‡å°‘**: 69 è¡Œ

---

## ğŸ“ æŠ€æœ¯äº®ç‚¹

### 1. ç®—æ³•ä¼˜åŒ–
- âœ… Im2Col å°†å·ç§¯è½¬ä¸ºçŸ©é˜µä¹˜æ³•
- âœ… åˆ©ç”¨é«˜åº¦ä¼˜åŒ–çš„ `NdArray.dot()` æ–¹æ³•
- âœ… å†…å­˜è®¿é—®æ¨¡å¼ä¼˜åŒ–ï¼Œæé«˜ç¼“å­˜å‘½ä¸­ç‡

### 2. æ¶æ„ä¼˜åŒ–
- âœ… èŒè´£åˆ†ç¦»: Function å±‚å¤„ç†ç®—æ³•ï¼ŒModule å±‚ç®¡ç†å‚æ•°
- âœ… ä»£ç å¤ç”¨: nnet å±‚å§”æ‰˜ç»™ func å±‚
- âœ… å¯æ‰©å±•æ€§: æœªæ¥å¯è½»æ¾æ›¿æ¢ä¸º Winograd ç­‰æ›´é«˜çº§ç®—æ³•

### 3. æ€§èƒ½ä¼˜åŒ–
- âœ… å‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€
- âœ… è¿ç»­å†…å­˜è®¿é—®
- âœ… ä¸ºæœªæ¥é›†æˆ BLAS åº“æ‰“ä¸‹åŸºç¡€

---

## ğŸš€ æœªæ¥ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸä¼˜åŒ– (1-2å‘¨)

1. **å¹¶è¡ŒåŒ–**
   - ä½¿ç”¨å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†ä¸åŒ batch
   - åˆ©ç”¨ Java Stream API å¹¶è¡ŒåŒ–

2. **å†…å­˜ä¼˜åŒ–**
   - å¤ç”¨ Im2Col ç¼“å†²åŒº
   - ä½¿ç”¨å¯¹è±¡æ± å‡å°‘ GC å‹åŠ›

### ä¸­æœŸä¼˜åŒ– (1-2æœˆ)

3. **ç®—æ³•ä¼˜åŒ–**
   - å¯¹å°å·ç§¯æ ¸ (1x1) ä½¿ç”¨ç›´æ¥å·ç§¯
   - å¯¹å¤§å·ç§¯æ ¸ (>3x3) è€ƒè™‘ Winograd ç®—æ³•

4. **åº•å±‚ä¼˜åŒ–**
   - é›†æˆ OpenBLAS æˆ– Intel MKL
   - ä½¿ç”¨ SIMD æŒ‡ä»¤åŠ é€Ÿ

### é•¿æœŸä¼˜åŒ– (3-6æœˆ)

5. **GPU åŠ é€Ÿ**
   - CUDA/OpenCL å®ç°
   - åˆ©ç”¨ GPU çš„å¹¶è¡Œè®¡ç®—èƒ½åŠ›

6. **é‡åŒ–ä¼˜åŒ–**
   - INT8 é‡åŒ–å·ç§¯
   - æ··åˆç²¾åº¦è®¡ç®—

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. **Im2Col ç®—æ³•**
   - Caffe æ¡†æ¶å®ç°
   - PyTorch åº•å±‚å®ç°å‚è€ƒ

2. **æ€§èƒ½ä¼˜åŒ–**
   - "High Performance Convolutional Neural Networks for Document Processing" (2006)
   - "Fast Algorithms for Convolutional Neural Networks" (Winograd, 2015)

3. **å·¥ç¨‹å®è·µ**
   - ä¸»æµæ·±åº¦å­¦ä¹ æ¡†æ¶ (PyTorch, TensorFlow, Caffe) å·ç§¯å®ç°

---

## ğŸ‘¥ è´¡çŒ®è€…

- **ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡**: TinyAI Team
- **ä»£ç å®ç°**: AI Assistant
- **æµ‹è¯•éªŒè¯**: è‡ªåŠ¨åŒ–æµ‹è¯•

---

## ğŸ“„ License

æœ¬ä¼˜åŒ–æ–¹æ¡ˆéµå¾ª TinyAI é¡¹ç›®è®¸å¯è¯ã€‚

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- [`Conv2d.java`](../src/main/java/io/leavesfly/tinyai/func/matrix/Conv2d.java) - åº•å±‚å®ç°
- [`Conv2d.java`](../../tinyai-deeplearning-nnet/src/main/java/io/leavesfly/tinyai/nnet/v2/layer/conv/Conv2d.java) - é«˜å±‚å°è£…
- [`Conv2dPerformanceTest.java`](../src/test/java/io/leavesfly/tinyai/func/matrix/Conv2dPerformanceTest.java) - æ€§èƒ½æµ‹è¯•

---

**æœ€åæ›´æ–°**: 2025-12-11  
**ç‰ˆæœ¬**: 2.0 (Im2Col ä¼˜åŒ–ç‰ˆ)
